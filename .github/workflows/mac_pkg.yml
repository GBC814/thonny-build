name: Build macOS PKG

on:
  push:
    branches: [ "master", "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python 3.10
        run: |
          # ä¸‹è½½å¹¶å®‰è£…å®˜æ–¹ Python 3.10.11ï¼Œè¿™æ˜¯è„šæœ¬æ‰€æœŸæœ›çš„æ¡†æ¶è·¯å¾„
          curl -O https://www.python.org/ftp/python/3.10.11/python-3.10.11-macos11.pkg
          sudo installer -pkg python-3.10.11-macos11.pkg -target /
          
      - name: Prepare Base Bundle
        working-directory: packaging/mac
        run: |
          # ç»™æ‰€æœ‰è„šæœ¬å’Œ Python æ–‡ä»¶æœ€é«˜æ‰§è¡Œæƒé™
          chmod +x *.sh *.py
          # å‡†å¤‡åŸºç¡€åŒ…ï¼ˆæ‹·è´ Python æ¡†æ¶ï¼‰
          ./prepare_base_bundle.sh

      - name: Prepare Dist Bundle
        working-directory: packaging/mac
        run: |
          # å†æ¬¡ç¡®ä¿æƒé™
          chmod +x *.sh *.py
          VERSION=$(cat ../../thonny/VERSION)
          echo "Building Thonny version $VERSION"
          
          # å½»åº•ç§»é™¤å¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥çš„æ—§ SDK è®¾ç½®
          sed -i '' 's/export MACOSX_DEPLOYMENT_TARGET=/#/g' prepare_dist_bundle.sh
          sed -i '' 's/export SDKROOT=/#/g' prepare_dist_bundle.sh
          
          # å¤„ç†ç¼ºå¤±çš„ universal_dists ç›®å½•
          if [ ! -d "universal_dists" ]; then
            echo "universal_dists not found, patching prepare_dist_bundle.sh to skip them"
            sed -i '' 's/.*pip install universal_dists.*/# skipped/g' prepare_dist_bundle.sh
          fi
          
          # æ‰§è¡Œæ‰“åŒ…å‡†å¤‡å·¥ä½œ
          ./prepare_dist_bundle.sh $VERSION ../requirements-regular-bundle-310.txt
          
          # æ£€æŸ¥ä½“ç§¯
          echo "App bundle size details:"
          du -sh build/Thonny.app
          du -d 2 -h build/Thonny.app/Contents/Frameworks

      - name: Create Installer (PKG)
        working-directory: packaging/mac
        run: |
          VERSION=$(cat ../../thonny/VERSION)
          
          # ç¡®ä¿ dist æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œé˜²æ­¢ productbuild æŠ¥é”™
          mkdir -p dist
          
          # ç§»é™¤ç¡¬ç¼–ç çš„ç­¾åè¦æ±‚
          sed -i '' 's/--sign "$INSTALLER_SIGN_ID"//g' create_installer_from_build.sh
          
          # åˆ›å»º PKG
          ./create_installer_from_build.sh "thonny" "Thonny" $VERSION

      - name: Upload PKG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: thonny-${{ github.ref_name }}-macos-pkg
          path: packaging/mac/dist/*.pkg

      - name: Self-Test (Advanced Verification)
        run: |
          echo "Starting production-level self-test..."
          PKG_FILE=$(ls packaging/mac/dist/*.pkg)
          
          # 1. æ¨¡æ‹Ÿç”¨æˆ·å®‰è£…
          sudo installer -pkg "$PKG_FILE" -target /
          echo "âœ… PKG installed successfully to /Applications"
          
          # 2. éªŒè¯ App ç»“æ„
          if [ ! -d "/Applications/Thonny.app" ]; then
            echo "âŒ Error: Thonny.app missing!"
            exit 1
          fi
          
          # 3. éªŒè¯ Python ç¯å¢ƒå’Œ Thonny æºä»£ç 
          # å°è¯•åœ¨å®‰è£…åçš„ç¯å¢ƒä¸­å¯¼å…¥ thonny å¹¶æ‰“å°ç‰ˆæœ¬
          echo "Verifying Thonny internal source code..."
          /Applications/Thonny.app/Contents/MacOS/Python -c "import thonny; print('ğŸš€ Thonny ' + thonny.get_version() + ' is alive!')"
          
          # 4. éªŒè¯ä¾èµ–è·¯å¾„ï¼ˆé˜²æ­¢è·¯å¾„ç¡¬ç¼–ç æŠ¥é”™ï¼‰
          echo "Checking dynamic library links..."
          otool -L /Applications/Thonny.app/Contents/MacOS/Python | grep "@rpath"
          echo "âœ… Library path verification passed!"
